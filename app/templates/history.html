{% extends "base.html" %}
{% block title %}Storico movimenti ‚Äî Crocette{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto space-y-6">
  <div class="flex items-center justify-between">
    <h1 class="text-2xl font-bold">Storico movimenti</h1>
    <a href="/" class="text-sm underline opacity-80">‚Üê Torna alla dashboard</a>
  </div>

  <!-- Filtri -->
  <form method="get" action="/storico" class="p-4 rounded-2xl bg-neutral-800 grid md:grid-cols-4 gap-3 items-end">
    <div>
      <label class="block text-sm opacity-80 mb-1">Tipo</label>
      <select name="kind" class="w-full px-3 py-2 rounded bg-neutral-900">
        <option value="debit" {% if kind=='debit' %}selected{% endif %}>Solo debito</option>
        <option value="credit" {% if kind=='credit' %}selected{% endif %}>Solo credito</option>
        <option value="all" {% if kind not in ['debit','credit'] %}selected{% endif %}>Entrambi</option>
      </select>
    </div>
    <div class="md:col-span-2">
      <label class="block text-sm opacity-80 mb-1">Giocatore</label>
      <select name="member_id" class="w-full px-3 py-2 rounded bg-neutral-900">
        <option value="">‚Äî Tutti ‚Äî</option>
        {% for m in members %}
        <option value="{{ m.id }}" {% if member_id and m.id==member_id %}selected{% endif %}>{{ m.name }}</option>
        {% endfor %}
      </select>
    </div>
    <div>
      <button class="w-full px-4 py-2 rounded-lg bg-neutral-900 hover:bg-neutral-700">Applica</button>
    </div>
  </form>

  <!-- Totali -->
  <div class="p-4 rounded-xl bg-neutral-800 flex flex-wrap gap-6 items-center border border-neutral-700">
    <div>
      <span class="text-xs uppercase tracking-wider opacity-60 block">Movimenti trovati</span>
      <b class="text-xl">{{ moves|length }}</b>
    </div>
    <div>
      <span class="text-xs uppercase tracking-wider opacity-60 block">Somma crocette</span>
      <b class="text-xl">{{ total }}</b>
    </div>
  </div>

  <!-- Tabella -->
  <div class="overflow-x-auto rounded-2xl bg-neutral-900 border border-neutral-700">
    <table class="w-full text-sm">
      <thead class="bg-neutral-800 text-neutral-400">
        <tr>
          <th class="text-left p-3">Data</th>
          <th class="text-left p-3">Giocatore</th>
          <th class="text-left p-3">Tipo</th>
          <th class="text-left p-3">Crocette</th>
          <th class="text-left p-3">Regola</th>
          <th class="text-left p-3">Nota</th>
          {% if user and user.role == 'admin' %}
          <th class="text-left p-3">Azioni</th>
          {% endif %}
        </tr>
      </thead>
      <tbody>
        {% for m in moves %}
        <tr class="border-t border-neutral-800 hover:bg-neutral-800/50 transition-colors">
          <td class="p-3 whitespace-nowrap opacity-80 text-xs">{{ m.created_at.strftime('%d/%m/%Y %H:%M') }}</td>
          <td class="p-3 font-semibold">{{ m.member.name }}</td>
          <td class="p-3">
            {% if m.kind == 'debit' %}
            <span
              class="px-2 py-0.5 rounded-full bg-red-900/30 text-red-400 border border-red-800/50 text-[10px] uppercase font-bold">
              Debito
            </span>
            {% else %}
            <span
              class="px-2 py-0.5 rounded-full bg-green-900/30 text-green-400 border border-green-800/50 text-[10px] uppercase font-bold">
              Credito
            </span>
            {% endif %}
          </td>
          <td class="p-3">
            <span class="text-base font-mono {% if m.kind == 'debit' %}text-red-400{% else %}text-green-400{% endif %}">
              {{ '-' if m.kind == 'credit' else '+' }}{{ m.crocette }}
            </span>
          </td>
          <td class="p-3 opacity-80">{% if m.rule %}{{ m.rule.title }}{% else %}‚Äî{% endif %}</td>
          <td class="p-3 opacity-60 italic">{% if m.note %}{{ m.note }}{% else %}‚Äî{% endif %}</td>

          {% if user and user.role == 'admin' %}
          <td class="p-3">
            <form method="post" action="/movements/delete"
              onsubmit="return confirm('Eliminare definitivamente questo movimento?');" class="inline">
              <input type="hidden" name="movement_id" value="{{ m.id }}">
              <input type="hidden" name="next"
                value="/storico?kind={{ kind }}{% if member_id %}&member_id={{ member_id }}{% endif %}">
              <button
                class="px-3 py-1 rounded-md bg-neutral-800 border border-neutral-700 text-xs hover:bg-red-900/20 hover:border-red-800 transition-colors"
                title="Elimina">
                üóëÔ∏è Elimina
              </button>
            </form>
          </td>
          {% endif %}
        </tr>
        {% endfor %}
        {% if moves|length == 0 %}
        <tr>
          <td class="p-10 text-center opacity-40 uppercase tracking-widest"
            colspan="{% if user and user.role == 'admin' %}7{% else %}6{% endif %}">Nessun movimento trovato.</td>
        </tr>
        {% endif %}
      </tbody>
    </table>
  </div>
</div>
{% endblock %}
